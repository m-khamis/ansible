- name: "manage server1"
  hosts: all
  become: true
  tasks:

          - name:  "Clone a github repository"
            git:
                    repo: https://github.com/vaadin/addressbook
                    dest: /home/ubuntu/addressbook/
                    clone: yes
                    update: yes
          - name:  "install maven"
            apt: pkg=maven state=latest update_cache=yes cache_valid_time=3600


          - name: "Compile"
            command: chdir=/home/ubuntu/addressbook/ mvn package
            
          - name: add tomcat group
            group:
                  name: tomcat

          - name: add tomcat user
            user:
                  name: tomcat
                  group: tomcat
                  home: /user/share/tomcat
                  createhome: no

          - name: create /opt/tomcat directory
            file:
                 path: /opt/tomcat
                 state: directory
                 mode: 0755

         - name: download & unarchive
           unarchive:
                    src: http://apache.cs.utah.edu/tomcat/tomcat-9/v9.0.16/bin/apache-tomcat-9.0.16.tar.gz
                    dest: /opt/tomcat
                    remote_src: yes
                    extra_opts: [--strip-components=1]

         - name: Change ownership
            file:
                path: /opt/tomcat
                owner: tomcat
                group: tomcat
                mode: "u+rwx,g+rx,o=rx"
                recurse: yes
                state: directory

         - name: Copy Tomcat service from local to remote
           copy:
               src: tomcat.service
               dest: /etc/systemd/system/
               mode: 0755

         - name: Start and enable Tomcat service
           systemd:
                   name: tomcat
                   state: started
                   enabled: true
                   daemon_reload: true
      
